<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login Behavior Detection Demo</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      width: 100%;
      max-width: 420px;
    }
    .login-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 40px;
    }
    .login-card h1 {
      text-align: center;
      color: #333;
      margin-bottom: 8px;
      font-size: 28px;
    }
    .login-card .subtitle {
      text-align: center;
      color: #888;
      font-size: 14px;
      margin-bottom: 30px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      color: #555;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
    }
    .form-group input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .form-group input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
    }
    .consent-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 24px;
      font-size: 13px;
      color: #666;
    }
    .consent-row input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .btn-login {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn-login:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }
    .btn-login:active {
      transform: translateY(0);
    }
    
    /* Analysis Result Panel */
    .result-panel {
      margin-top: 20px;
      display: none;
    }
    .result-panel.show {
      display: block;
    }
    .result-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      border-radius: 10px;
      margin-bottom: 16px;
    }
    .result-header.human {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
    }
    .result-header.bot {
      background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
      color: white;
    }
    .result-header .verdict {
      font-size: 20px;
      font-weight: 700;
    }
    .result-header .confidence {
      font-size: 14px;
      opacity: 0.9;
    }
    .result-details {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 16px;
      font-size: 13px;
    }
    .result-details h4 {
      color: #333;
      margin-bottom: 12px;
      font-size: 14px;
    }
    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #e9ecef;
    }
    .detail-row:last-child {
      border-bottom: none;
    }
    .detail-row .label {
      color: #666;
    }
    .detail-row .value {
      color: #333;
      font-weight: 500;
      font-family: ui-monospace, monospace;
    }
    .warnings {
      margin-top: 12px;
    }
    .warning-item {
      background: #fff3cd;
      color: #856404;
      padding: 8px 12px;
      border-radius: 6px;
      margin-bottom: 6px;
      font-size: 12px;
    }
    .warning-item:before {
      content: "‚ö†Ô∏è ";
    }
    
    /* Bottom Action Buttons */
    .actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }
    .btn-secondary {
      flex: 1;
      padding: 10px;
      background: #f0f0f0;
      color: #555;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-secondary:hover {
      background: #e0e0e0;
    }
    
    /* Status Indicators */
    .status-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      font-size: 11px;
    }
    .status-item {
      display: flex;
      align-items: center;
      gap: 4px;
      color: #888;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ccc;
    }
    .status-dot.active {
      background: #38ef7d;
    }
    .status-dot.warning {
      background: #f5a623;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="login-card">
      <h1>Login</h1>
      <p class="subtitle">Behavior Detection Demo</p>
      
      <div class="status-bar">
        <div class="status-item">
          <span class="status-dot" id="dotTdna"></span>
          <span>TypingDNA</span>
        </div>
        <div class="status-item">
          <span class="status-dot" id="dotTraj"></span>
          <span>Trajectory</span>
        </div>
        <div class="status-item">
          <span class="status-dot" id="dotConsent"></span>
          <span>Consent</span>
        </div>
      </div>
      
      <form id="loginForm">
        <div class="form-group">
          <label for="username">Username / Email</label>
          <input type="text" id="username" name="username" autocomplete="off" placeholder="Type manually, do not paste" />
        </div>
        
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" name="password" autocomplete="off" placeholder="Type manually, do not paste" />
        </div>
        
        <div class="consent-row">
          <input type="checkbox" id="consent" checked />
          <label for="consent">Allow typing behavior collection for security analysis</label>
        </div>
        
        <button type="submit" class="btn-login">Login & Analyze</button>
      </form>
      
      <div class="result-panel" id="resultPanel">
        <div class="result-header" id="resultHeader">
          <div>
            <div class="verdict" id="verdict">-</div>
            <div class="confidence" id="confidenceText">-</div>
          </div>
          <div style="font-size: 36px;" id="resultIcon">-</div>
        </div>
        
        <div class="result-details">
          <h4>Username Typing Features</h4>
          <div class="detail-row">
            <span class="label">Keystroke Count</span>
            <span class="value" id="userKeyCount">-</span>
          </div>
          <div class="detail-row">
            <span class="label">SeekTime (avg/std)</span>
            <span class="value" id="userSeek">-</span>
          </div>
          <div class="detail-row">
            <span class="label">PressTime (avg/std)</span>
            <span class="value" id="userPress">-</span>
          </div>
          
          <h4 style="margin-top: 16px;">Password Typing Features</h4>
          <div class="detail-row">
            <span class="label">Keystroke Count</span>
            <span class="value" id="passKeyCount">-</span>
          </div>
          <div class="detail-row">
            <span class="label">SeekTime (avg/std)</span>
            <span class="value" id="passSeek">-</span>
          </div>
          <div class="detail-row">
            <span class="label">PressTime (avg/std)</span>
            <span class="value" id="passPress">-</span>
          </div>
          
          <h4 style="margin-top: 16px;">Other Features</h4>
          <div class="detail-row">
            <span class="label">Username‚ÜíPassword Gap</span>
            <span class="value" id="u2pTime">-</span>
          </div>
          <div class="detail-row">
            <span class="label">Mouse Trajectory Points</span>
            <span class="value" id="trajPoints">-</span>
          </div>
          <div class="detail-row">
            <span class="label">Paste Count</span>
            <span class="value" id="pasteCount">-</span>
          </div>
          <div class="detail-row">
            <span class="label">IME Input Method</span>
            <span class="value" id="imeCount">-</span>
          </div>
          <div class="detail-row">
            <span class="label">Shift Key Usage</span>
            <span class="value" id="shiftCount">-</span>
          </div>
          <div class="detail-row">
            <span class="label">CapsLock Usage</span>
            <span class="value" id="capsLockCount">-</span>
          </div>
          
          <div class="warnings" id="warnings"></div>
        </div>
        
        <div class="actions">
          <button class="btn-secondary" id="btnReset">Reset</button>
          <button class="btn-secondary" id="btnExport">Export JSON</button>
        </div>
      </div>
    </div>
  </div>

  <!-- TypingDNA Library -->
  <script src="https://www.typingdna.com/scripts/typingdna.js"></script>
  
  <!-- Behavior Analyzer -->
  <script src="typing-analyzer.js"></script>
  
  <script>
    // ============================================================
    // State Variables
    // ============================================================
    let tdna = null;
    let tdnaReady = false;
    let stats = {
      usernameToPasswordMs: null,
      passwordToLoginMs: null,
      pasteUser: 0,
      pastePass: 0,
      imeUser: 0,
      imePass: 0,
      shiftCount: 0,
      capsLockCount: 0,
      trajectory: {
        captured: false,
        points: 0,
        distancePx: 0,
        sample: []
      },
      typingdna: {
        lastUserTp: "",
        lastPassTp: ""
      }
    };
    
    let usernameFocusTime = null;
    let passwordFocusTime = null;
    let lastPointerPos = null;
    let trajectoryStarted = false;
    
    // DOM ÂÖÉÁ¥†
    const usernameField = document.getElementById("username");
    const passwordField = document.getElementById("password");
    const loginForm = document.getElementById("loginForm");
    const consentChk = document.getElementById("consent");
    const resultPanel = document.getElementById("resultPanel");
    
    // Áä∂ÊÄÅÊåáÁ§∫Âô®
    const dotTdna = document.getElementById("dotTdna");
    const dotTraj = document.getElementById("dotTraj");
    const dotConsent = document.getElementById("dotConsent");
    
    // ============================================================
    // Initialize TypingDNA
    // ============================================================
    function initTypingDNA() {
      if (typeof TypingDNA === "undefined") {
        console.warn("TypingDNA library not loaded");
        return;
      }
      
      tdna = new TypingDNA();
      tdna.addTarget("username");
      tdna.addTarget("password");
      if (typeof tdna.start === "function") tdna.start();
      tdnaReady = true;
      dotTdna.classList.add("active");
      console.log("TypingDNA initialized successfully");
    }
    
    // Delayed initialization
    setTimeout(initTypingDNA, 500);
    
    // ============================================================
    // Paste Detection
    // ============================================================
    usernameField.addEventListener("paste", () => {
      stats.pasteUser++;
    });
    
    passwordField.addEventListener("paste", () => {
      stats.pastePass++;
    });
    
    // ============================================================
    // IME Input Method Detection (Human Indicator)
    // ============================================================
    usernameField.addEventListener("compositionstart", () => {
      stats.imeUser++;
    });
    
    passwordField.addEventListener("compositionstart", () => {
      stats.imePass++;
    });
    
    // ============================================================
    // Shift/CapsLock Detection (Human Indicator)
    // ============================================================
    passwordField.addEventListener("keydown", (e) => {
      if (e.key === "Shift") {
        stats.shiftCount++;
      }
      if (e.key === "CapsLock") {
        stats.capsLockCount++;
      }
    });
    
    // ============================================================
    // Time Recording
    // ============================================================
    usernameField.addEventListener("focus", () => {
      usernameFocusTime = Date.now();
      trajectoryStarted = true;
      stats.trajectory.captured = true;
      dotTraj.classList.add("active");
    });
    
    passwordField.addEventListener("focus", () => {
      if (usernameFocusTime) {
        stats.usernameToPasswordMs = Date.now() - usernameFocusTime;
      }
      passwordFocusTime = Date.now();
    });
    
    // ============================================================
    // Mouse Trajectory
    // ============================================================
    document.addEventListener("pointermove", (e) => {
      if (!trajectoryStarted || !consentChk.checked) return;
      
      const point = { x: e.clientX, y: e.clientY, t: Date.now() };
      
      if (lastPointerPos) {
        const dx = point.x - lastPointerPos.x;
        const dy = point.y - lastPointerPos.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if (dist > 5) {
          stats.trajectory.distancePx += dist;
          stats.trajectory.points++;
          if (stats.trajectory.sample.length < 50) {
            stats.trajectory.sample.push(point);
          }
        }
      }
      lastPointerPos = point;
    });
    
    // ============================================================
    // Consent Status
    // ============================================================
    consentChk.addEventListener("change", () => {
      dotConsent.classList.toggle("active", consentChk.checked);
    });
    dotConsent.classList.add("active"); // Checked by default
    
    // ============================================================
    // Form Submission
    // ============================================================
    loginForm.addEventListener("submit", (e) => {
      e.preventDefault();
      
      if (passwordFocusTime) {
        stats.passwordToLoginMs = Date.now() - passwordFocusTime;
      }
      
      // Save password value for analysis (check uppercase/special chars vs Shift usage)
      stats.password = passwordField.value;
      
      // Get TypingDNA pattern
      if (tdnaReady && tdna && consentChk.checked) {
        const username = usernameField.value;
        const password = passwordField.value;
        
        try {
          stats.typingdna.lastUserTp = tdna.getTypingPattern({ type: 1, text: username, targetId: "username" }) || "";
          stats.typingdna.lastPassTp = tdna.getTypingPattern({ type: 1, text: password, targetId: "password" }) || "";
        } catch (err) {
          console.error("Failed to get TypingDNA pattern:", err);
        }
      }
      
      // Analyze and show results
      showAnalysisResult();
    });
    
    // ============================================================
    // Show Analysis Results
    // ============================================================
    function showAnalysisResult() {
      const result = TypingAnalyzer.analyzeLogin(stats);
      const userPattern = TypingAnalyzer.parsePattern(stats.typingdna.lastUserTp);
      const passPattern = TypingAnalyzer.parsePattern(stats.typingdna.lastPassTp);
      
      // Show panel
      resultPanel.classList.add("show");
      
      // Result header
      const header = document.getElementById("resultHeader");
      const verdict = document.getElementById("verdict");
      const confidenceText = document.getElementById("confidenceText");
      const resultIcon = document.getElementById("resultIcon");
      
      if (result.isBot) {
        header.className = "result-header bot";
        verdict.textContent = "Abnormal Behavior Detected";
        resultIcon.textContent = "ü§ñ";
      } else {
        header.className = "result-header human";
        verdict.textContent = "Normal Behavior";
        resultIcon.textContent = "‚úÖ";
      }
      confidenceText.textContent = `Bot Probability: ${result.confidence}%`;
      
      // Username features
      document.getElementById("userKeyCount").textContent = userPattern ? userPattern.keystrokeCount : "-";
      document.getElementById("userSeek").textContent = userPattern 
        ? `${userPattern.seekTime.avg}ms / ${userPattern.seekTime.std}ms` : "-";
      document.getElementById("userPress").textContent = userPattern 
        ? `${userPattern.pressTime.avg}ms / ${userPattern.pressTime.std}ms` : "-";
      
      // Password features
      document.getElementById("passKeyCount").textContent = passPattern ? passPattern.keystrokeCount : "-";
      document.getElementById("passSeek").textContent = passPattern 
        ? `${passPattern.seekTime.avg}ms / ${passPattern.seekTime.std}ms` : "-";
      document.getElementById("passPress").textContent = passPattern 
        ? `${passPattern.pressTime.avg}ms / ${passPattern.pressTime.std}ms` : "-";
      
      // Other features
      document.getElementById("u2pTime").textContent = stats.usernameToPasswordMs 
        ? `${stats.usernameToPasswordMs}ms` : "-";
      document.getElementById("trajPoints").textContent = stats.trajectory.points;
      document.getElementById("pasteCount").textContent = `${stats.pasteUser + stats.pastePass}`;
      document.getElementById("imeCount").textContent = `${stats.imeUser + stats.imePass}`;
      document.getElementById("shiftCount").textContent = stats.shiftCount || 0;
      document.getElementById("capsLockCount").textContent = stats.capsLockCount || 0;
      
      // Warning messages
      const warningsDiv = document.getElementById("warnings");
      warningsDiv.innerHTML = "";
      result.reasons.forEach(reason => {
        const div = document.createElement("div");
        div.className = "warning-item";
        div.textContent = reason;
        warningsDiv.appendChild(div);
      });
    }
    
    // ============================================================
    // Reset
    // ============================================================
    document.getElementById("btnReset").addEventListener("click", () => {
      // Reset form
      loginForm.reset();
      consentChk.checked = true;
      
      // Reset state
      stats = {
        usernameToPasswordMs: null,
        passwordToLoginMs: null,
        pasteUser: 0,
        pastePass: 0,
        imeUser: 0,
        imePass: 0,
        shiftCount: 0,
        capsLockCount: 0,
        trajectory: { captured: false, points: 0, distancePx: 0, sample: [] },
        typingdna: { lastUserTp: "", lastPassTp: "" }
      };
      usernameFocusTime = null;
      passwordFocusTime = null;
      lastPointerPos = null;
      trajectoryStarted = false;
      
      // Reset TypingDNA
      if (tdna && typeof tdna.reset === "function") {
        tdna.reset();
      }
      
      // Hide results
      resultPanel.classList.remove("show");
      
      // Reset status indicators
      dotTraj.classList.remove("active");
      dotConsent.classList.add("active");
    });
    
    // ============================================================
    // Export JSON
    // ============================================================
    document.getElementById("btnExport").addEventListener("click", () => {
      const exportData = {
        exportedAt: new Date().toISOString(),
        stats: stats,
        analysis: TypingAnalyzer.analyzeLogin(stats)
      };
      
      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `login-behavior-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
